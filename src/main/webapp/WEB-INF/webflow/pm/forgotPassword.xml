<?xml version="1.0" encoding="UTF-8"?>
<flow parent="common" xmlns="http://www.springframework.org/schema/webflow"
			xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
			xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">
  
  <var name="setPasswordBean" class="net.unicon.cas.passwordmanager.flow.model.SetPasswordBean" />
  <var name="netIdBean" class="net.unicon.cas.passwordmanager.flow.model.NetIdBean"/>

	<view-state id="viewForgotPassword" view="casPmForgotPassword" model="netIdBean">
		<binder>
			<binding property="netId"/>
		</binder>
		<on-render>
			<set name="viewScope.recaptchaSiteKey" value="recaptchaValidationAction.getSiteKey()"/>
		</on-render>
		<transition on="submit" bind="true" validate="true" to="validateCaptcha">
			<evaluate expression="lockoutService.allowAttempt(netIdBean.netId)" />
			<set name="flowScope.username" value="netIdBean.netId"/>
		</transition>
		<transition on="return" bind="false" validate="false" to="pmExit"/>
	</view-state>
  
  <action-state id="validateCaptcha">
    <evaluate expression="recaptchaValidationAction" />
    <transition on="error" to="viewForgotPassword" />
    <transition on="yes" to="loadSecurityChallenge" />
    <transition on="no" to="viewForgotPassword" />
  </action-state>
  
	<decision-state id="loadSecurityChallenge">
		<on-entry>
			<evaluate expression="ldapPasswordManagerService.getSecurityChallenge(flowScope.username)" result="flowScope.securityChallenge"/>
		</on-entry>
		<if test="flowScope.securityChallenge != null and flowScope.securityChallenge.questions != null
                and flowScope.securityChallenge.questions.size() > 0"
				then="answerSecurityChallenge"
				else="helpDeskView" />
	</decision-state>
  
	<!-- 
	| This is an ancillary screen.  You get here by passing through the 
	| 'forgotPassword' screen.  It will display the following:
	|   - Your custom security question (if already set up)
	|   - Your default required questions
	+-->
	<view-state id="answerSecurityChallenge" view="casPmAnswerSecurityQuestion" model="securityChallenge">
		<transition on="submit" bind="true" validate="true" to="checkSecurityChallengeResponse" />
    <transition on="return" bind="false" validate="false" to="pmExit" />
	</view-state>
  
	<action-state id="checkSecurityChallengeResponse">
		<evaluate expression="checkSecurityQuestionResponseAction" />
		<transition on="success" to="viewSetPassword"/>
		<transition on="error" to="answerSecurityChallenge">
			<set name="requestScope.securityQuestionValidationError" value="true" />
		</transition>
	</action-state>
	
	<view-state id="viewSetPassword" view="casPmChangePassword" model="setPasswordBean">
		<binder>
			<binding property="newPassword"/>
			<binding property="confirmNewPassword"/>
		</binder>
    <on-entry>
      <set name="setPasswordBean.username" value="flowScope.username" />
    </on-entry>
		<on-render>
      <set name="viewScope.commandName" value="'setPasswordBean'" />
		</on-render>
    <transition on="submit" bind="true" validate="true" to="setPassword" />
    <transition on="return" to="pmExit" validate="false" bind="false"/>
	</view-state>
  
  <action-state id="setPassword">
    <evaluate expression="processChangePasswordAction.setPassword" />
    <transition on="success" to="passwordSet" />
    <transition on="error" to="viewSetPassword" />
  </action-state>
    
	<view-state id="passwordSet" view="casPmChangedPassword">
		<transition to="pmExit" />
	</view-state>

</flow>
